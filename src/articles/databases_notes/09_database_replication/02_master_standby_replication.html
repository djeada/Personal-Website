<!DOCTYPE html>

<html lang="en">

<head>
    <script async="" crossorigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5593122079896089"></script>
    <meta charset="utf-8" />
    <title>Master-Standby Replication</title>
    <meta content="Master-Standby replication is a widely adopted database replication topology where a primary database server, known as the master, replicates data to one or more secondary servers called standbys." name="description" />
    <meta content="Adam Djellouli" name="author" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <link crossorigin="" href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://raw.githubusercontent.com/djeada/Personal-Website/master/images/icon.ico" rel="icon" />
    <link href="../../../resources/style.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://adamdjellouli.com/articles/databases_notes/09_database_replication/02_master_standby_replication" rel="canonical" />
    <script id="structured-data" type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Article",
            "headline": "Master-Standby Replication",
            "author": {
                "@type": "Person",
                "name": "Adam Djellouli"
            },
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://adamdjellouli.com/articles/databases_notes/09_database_replication/02_master_standby_replication"
            },
            "url": "https://adamdjellouli.com/articles/databases_notes/09_database_replication/02_master_standby_replication",
            "description": "Master-Standby replication is a widely adopted database replication topology where a primary database server, known as the master, replicates data to one or more secondary servers called standbys.",
            "dateModified": "2018-05-23"
        }
    </script>
</head>

<body>
    <nav aria-label="Main navigation">
        <a class="logo" href="../../../index.html">
            <img alt="Adam Djellouli - Home Page Logo" id="logo-image" src="https://raw.githubusercontent.com/djeada/Personal-Website/master/images/logo.PNG" />
        </a>
        <input aria-label="Toggle navigation menu" id="navbar-toggle" type="checkbox" />
        <ul aria-labelledby="navbar-toggle" role="menu">
            <li role="menuitem">
                <a href="../../../index.html" title="Go to Home Page"> Home </a>
            </li>
            <li role="menuitem">
                <a href="../../../core/blog.html" title="Read Adam Djellouli Blog on Programming and Technology"> Blog </a>
            </li>
            <li role="menuitem">
                <a href="../../../core/tools.html" title="Discover Tools Created by Adam Djellouli"> Tools </a>
            </li>
            <li role="menuitem">
                <a href="../../../core/projects.html" title="Explore Projects Developed by Adam Djellouli"> Projects </a>
            </li>
            <li role="menuitem">
                <a href="../../../core/courses.html" title="Browse Courses by Adam Djellouli"> Courses </a>
            </li>
            <li role="menuitem">
                <a href="../../../core/resume.html" title="View Adam Djellouli Professional Resume"> Resume </a>
            </li>
            <li>
                <script async="" src="https://cse.google.com/cse.js?cx=8160ef9bb935f4f68"></script>
                <div class="gcse-search"></div>
            </li>
            <li>
                <button aria-label="Toggle dark mode" id="dark-mode-button"></button>
            </li>
        </ul>
    </nav>
    <div id="article-wrapper">
        <aside id="article-sidebar">
            <div id="table-of-contents">
                <h2>Table of Contents</h2>
                <ol><a href="#master-standby-replication">Master-Standby Replication</a>
                    <ol>
                        <li><a href="#understanding-the-architecture">Understanding the Architecture</a></li>
                        <li><a href="#the-purpose-of-master-standby-replication">The Purpose of Master-Standby Replication</a></li>
                        <li><a href="#advantages">Advantages</a></li>
                        <li><a href="#challenges">Challenges</a></li>
                        <li><a href="#implementing-in-postgresql">Implementing in PostgreSQL</a>
                            <ol>
                                <li><a href="#prerequisites">Prerequisites</a></li>
                                <li><a href="#configuring-node-1-master-">Configuring Node-1 (Master)</a></li>
                                <li><a href="#configuring-node-2-and-node-3-replicas-">Configuring Node-2 and Node-3 (Replicas)</a></li>
                                <li><a href="#verifying-replication">Verifying Replication</a></li>
                                <li><a href="#performing-a-fail-over">Performing a Fail-over</a></li>
                                <li><a href="#optional-replication-slots-highly-recommended-">Optional: Replication Slots (Highly Recommended)</a></li>
                                <li><a href="#extra-hardening-performance-tweaks">Extra Hardening &amp; Performance Tweaks</a></li>
                            </ol>
                        </li>
                    </ol>
                </ol>
            </div>
            <div id="related-articles">
                <h2>Related Articles</h2>
                <ol>
                    <li>Introduction to Databases<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/01_introduction_to_databases/01_databases_intro.html">Databases Intro</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/01_introduction_to_databases/02_types_of_databases.html">Types of Databases</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/01_introduction_to_databases/03_database_management_systems_dbms_.html">Database Management Systems Dbms</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/01_introduction_to_databases/04_data_models.html">Data Models</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/01_introduction_to_databases/05_glossary.html">Glossary</a></li>
                        </ol>
                    </li>
                    <li>Database Design<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/02_database_design/01_requirements_analysis.html">Requirements Analysis</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/02_database_design/02_normalization.html">Normalization</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/02_database_design/03_denormalization.html">Denormalization</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/02_database_design/04_indexing_strategies.html">Indexing Strategies</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/02_database_design/05_data_integrity.html">Data Integrity</a></li>
                        </ol>
                    </li>
                    <li>Sql<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/01_intro_to_sql.html">Intro to Sql</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/02_data_definition_language_ddl.html">Data Definition Language Ddl</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/03_data_manipulation_language_dml.html">Data Manipulation Language Dml</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/04_data_control_language_dcl.html">Data Control Language Dcl</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/05_transaction_control_language_tcl.html">Transaction Control Language Tcl</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/06_joins_subqueries_and_views.html">Joins Subqueries and Views</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/07_stored_procedures_and_functions.html">Stored Procedures and Functions</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/08_triggers.html">Triggers</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/09_hierarchical_data.html">Hierarchical Data</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/10_aggregate_functions.html">Aggregate Functions</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/03_sql/11_window_functions.html">Window Functions</a></li>
                        </ol>
                    </li>
                    <li>Acid Properties and Transactions<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/04_acid_properties_and_transactions/01_transactions_intro.html">Transactions Intro</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/04_acid_properties_and_transactions/02_atomicity.html">Atomicity</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/04_acid_properties_and_transactions/03_consistency.html">Consistency</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/04_acid_properties_and_transactions/04_isolation.html">Isolation</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/04_acid_properties_and_transactions/05_durability.html">Durability</a></li>
                        </ol>
                    </li>
                    <li>Storage and Indexing<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/05_storage_and_indexing/01_how_tables_and_indexes_are_stored_on_disk.html">How Tables and Indexes Are Stored on Disk</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/05_storage_and_indexing/02_row_based_vs_column_based_databases.html">Row Based vs Column Based Databases</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/05_storage_and_indexing/03_primary_key_vs_secondary_key.html">Primary Key vs Secondary Key</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/05_storage_and_indexing/04_database_pages.html">Database Pages</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/05_storage_and_indexing/05_indexing.html">Indexing</a></li>
                        </ol>
                    </li>
                    <li>Distributed Databases<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/01_distributed_database_systems.html">Distributed Database Systems</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/02_partitioning.html">Partitioning</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/03_sharding.html">Sharding</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/04_partitioning_vs_sharding.html">Partitioning vs Sharding</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/05_consistent_hashing.html">Consistent Hashing</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/06_cap_theorem.html">Cap Theorem</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/07_eventual_consistency.html">Eventual Consistency</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/06_distributed_databases/08_distributed_database_systems.html">Distributed Database Systems</a></li>
                        </ol>
                    </li>
                    <li>Concurrency Control<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/07_concurrency_control/01_shared_vs_exclusive_locks.html">Shared vs Exclusive Locks</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/07_concurrency_control/02_deadlocks.html">Deadlocks</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/07_concurrency_control/03_two_phase_locking.html">Two Phase Locking</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/07_concurrency_control/04_double_booking_problem.html">Double Booking Problem</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/07_concurrency_control/05_serializable_vs_repeatable_read.html">Serializable vs Repeatable Read</a></li>
                        </ol>
                    </li>
                    <li>Database Performance<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/08_database_performance/01_query_optimization_techniques.html">Query Optimization Techniques</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/08_database_performance/02_indexing_strategies.html">Indexing Strategies</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/08_database_performance/03_database_caching.html">Database Caching</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/08_database_performance/04_materialized_views.html">Materialized Views</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/08_database_performance/05_accessing_database_in_code.html">Accessing Database in Code</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/08_database_performance/06_working_with_billion_row_table.html">Working with Billion Row Table</a></li>
                        </ol>
                    </li>
                    <li>Database Replication<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/09_database_replication/01_intro_to_replication.html">Intro to Replication</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/09_database_replication/02_master_standby_replication.html">Master Standby Replication</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/09_database_replication/03_multi_master_replication.html">Multi Master Replication</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/09_database_replication/04_synchronous_vs_asynchronous_replication.html">Synchronous vs Asynchronous Replication</a></li>
                        </ol>
                    </li>
                    <li>Nosql Databases<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/10_nosql_databases/01_nosql_databases_intro.html">Nosql Databases Intro</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/10_nosql_databases/02_types_of_nosql_databases.html">Types of Nosql Databases</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/10_nosql_databases/03_querying_nosql_databases.html">Querying Nosql Databases</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/10_nosql_databases/04_crud_in_sql_vs_nosql.html">Crud in Sql vs Nosql</a></li>
                        </ol>
                    </li>
                    <li>Security Best Practices<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/11_security_best_practices/01_backup_and_recovery_strategies.html">Backup and Recovery Strategies</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/11_security_best_practices/02_database_security.html">Database Security</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/11_security_best_practices/03_capacity_planning.html">Capacity Planning</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/11_security_best_practices/04_database_migration.html">Database Migration</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/11_security_best_practices/05_performance_monitoring_and_tuning.html">Performance Monitoring and Tuning</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/11_security_best_practices/06_sql_injection.html">Sql Injection</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/11_security_best_practices/07_crash_recovery_in_databases.html">Crash Recovery in Databases</a></li>
                        </ol>
                    </li>
                    <li>Database Engines<ol>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/12_database_engines/01_sqlite.html">Sqlite</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/12_database_engines/02_mysql.html">Mysql</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/12_database_engines/03_postgresql.html">Postgresql</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/12_database_engines/04_mongodb.html">Mongodb</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/12_database_engines/05_neo4j.html">Neo4J</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/12_database_engines/06_aws_services.html">Aws Services</a></li>
                            <li><a href="https://adamdjellouli.com/articles/databases_notes/12_database_engines/07_choosing_database.html">Choosing Database</a></li>
                        </ol>
                    </li>
                </ol>
            </div>
        </aside><article-section id="article-body">
            <div class="article-action-buttons"><button class="btn-suggest-edit" title="Suggest Edit">
                    <svg fill="none" height="20" viewbox="0 0 24 24" width="20">
                        <path d="M4 21h4l11-11-4-4L4 17v4z" stroke="currentColor" stroke-width="2"></path>
                    </svg>
                </button><button class="btn-create-issue" title="Create Issue">
                    <svg fill="none" height="20" viewbox="0 0 24 24" width="20">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"></circle>
                        <line stroke="currentColor" stroke-width="2" x1="12" x2="12" y1="8" y2="12"></line>
                        <circle cx="12" cy="16" fill="currentColor" r="1"></circle>
                    </svg>
                </button><button class="btn-download" title="Download">
                    <svg fill="none" height="20" viewbox="0 0 24 24" width="20">
                        <path d="M12 5v14m0 0l-6-6m6 6l6-6" stroke="currentColor" stroke-width="2"></path>
                    </svg>
                </button></div>
            <p style="text-align: right;"><i>Last modified: May 23, 2018</i></p>
            <p style="text-align: right;"><i>This article is written in: ğŸ‡ºğŸ‡¸</i></p>
            <h2 id="master-standby-replication">Master-Standby Replication</h2>
            <p>Master-Standby replication is a widely adopted database replication topology where a primary database server, known as the master, replicates data to one or more secondary servers called standbys. This setup enhances data availability, fault tolerance, and load balancing within a database system. Standby servers can handle read-only queries and, in case of a master server failure, can be promoted to become the new master, ensuring continuous operation.</p>
            <h3 id="understanding-the-architecture">Understanding the Architecture</h3>
            <p>To visualize how Master-Standby replication works, consider the following diagram:</p>
            <div>
                <pre><code class="language-shell">#
               +---------------------+
               |                     |
               |      Clients        |
               | (Write &amp; Read Ops)  |
               |                     |
               +----------+----------+
                          |
           +--------------+--------------+---------------------------------+
           |                             |                                 |
 Write &amp; Read Operations           Read Operations                   Read Operations
           |                             |                                 |
           v                             v                                 v
+----------+-----------+       +---------+----------+            +---------+----------+
|                      |       |                    |            |                    |
|    Master Server     |       |  Standby Server 1  |            |  Standby Server 2  |
|                      |       |  (Read-Only)       |            |  (Read-Only)       |
+----------+-----------+       +---------+----------+            +---------+----------+
           |                             ÊŒ                                 ÊŒ
           |                             |                                 |
           |                         Replication                       Replication
           |                             |                                 |
           +-----------------------------+---------------------------------+</code></pre>
            </div>
            <p>In this architecture, the master server handles all write operations, such as inserts, updates, and deletes. The standby servers continuously receive data changes from the master to stay synchronized and can serve read-only queries, offloading read traffic from the master. This arrangement not only improves performance but also provides a failover mechanism in case the master server becomes unavailable.</p>
            <h3 id="the-purpose-of-master-standby-replication">The Purpose of Master-Standby Replication</h3>
            <p>Master-Standby replication serves several essential purposes in database systems:</p>
            <ol>
                <li>By replicating data to standby servers, the system can prevent data loss and minimize downtime during failures. If the master server fails, a standby can be promoted to take over, ensuring uninterrupted service.</li>
                <li>Offloading read-heavy operations to standby servers distributes the workload more evenly, enhancing performance and scalability. This allows the master server to focus on write operations without being overwhelmed.</li>
                <li>Regular maintenance tasks, such as backups or software updates, can be performed on the master or standby servers without significant downtime. Standby servers can be updated one at a time, providing continuous service to users.</li>
                <li>As demand on the database grows, additional standby servers can be added to handle increased read traffic. This horizontal scaling is a cost-effective way to enhance system capacity without overhauling the existing infrastructure.</li>
            </ol>
            <h3 id="advantages">Advantages</h3>
            <p>Implementing Master-Standby replication offers several benefits:</p>
            <ul>
                <li>With standby servers acting as backups, the risk of data loss is significantly reduced. In the event of a failure, a standby can quickly take over as the master.</li>
                <li>Distributing read queries to standby servers alleviates the load on the master server, resulting in faster response times for users.</li>
                <li>The ability to promote a standby server to master simplifies the failover process, minimizing service interruptions and ensuring business continuity.</li>
                <li>Continuous replication ensures that data remains consistent across all servers, maintaining data integrity throughout the system.</li>
            </ul>
            <h3 id="challenges">Challenges</h3>
            <p>Despite its advantages, Master-Standby replication presents some challenges:</p>
            <ul>
                <li>Standby servers may not always be perfectly synchronized with the master, leading to potential stale reads. This <strong>lag</strong> can be problematic for applications requiring real-time data.</li>
                <li>Promoting a standby to master requires careful <strong>coordination</strong> to prevent data inconsistencies. Automated failover mechanisms need to be thoroughly tested to ensure reliability.</li>
                <li>Since only the master handles write operations, applications with heavy write loads may face scalability issues. The master server can become a <strong>bottleneck</strong> if not properly managed.</li>
                <li>Setting up and managing replication involves intricate configurations and ongoing monitoring. Administrators need to be skilled in replication technologies to maintain the system effectively.</li>
            </ul>
            <h3 id="implementing-in-postgresql">Implementing in PostgreSQL</h3>
            <p>PostgreSQL offers built-in support for streaming replication, making it a suitable choice for implementing Master-Standby replication. Below is a practical example of how to set up this replication using PostgreSQL.</p>
            <div>
                <pre><code class="language-text">Topology:
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                           â”‚  â”‚  Master / Primary  â”‚  â”‚
                           â”‚  â”‚  Node-1 10.0.0.10  â”‚  â”‚
                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                           â”‚            â”‚             â”‚
                           â”‚   (async or synchronous) â”‚
                           â”‚            â”‚             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                                       â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚  Replica-1         â”‚                       â”‚  Replica-2         â”‚  â”‚
   â”‚  â”‚  Node-2 10.0.0.11  â”‚      Streaming        â”‚  Node-3 10.0.0.12  â”‚  â”‚
   â”‚  â”‚  (Hot-Standby)     â”‚ &lt;--- Replication ---&gt; â”‚  (Hot-Standby)     â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
            </div>
            <blockquote>
                <p><strong>Legend</strong> â€“ We will call the nodes <strong>Node-1 (master)</strong>, <strong>Node-2 (replica-1)</strong> and <strong>Node-3 (replica-2)</strong> throughout.
                    Keep the diagram handy: configuration snippets below reference the IPs exactly as shown.</p>
            </blockquote>
            <h4 id="prerequisites">Prerequisites</h4>
            <ul>
                <li><strong>Three PostgreSQL instances installed</strong> (same major version) on <em>10.0.0.10</em>, <em>10.0.0.11</em>, <em>10.0.0.12</em>.</li>
                <li><strong>Network reachability</strong> â€“ TCP 5432 open bidirectionally (replicas must also talk <em>back</em> to the master for <code>pg_basebackup</code>).</li>
                <li><strong>Time synchronisation</strong> â€“ enable <code>chrony</code>/<code>ntpd</code>; replication breaks if clocks drift.</li>
                <li><strong>Adequate resources</strong> â€“ WAL can spike; leave at least 30 % free disk on the master.</li>
                <li><strong>Linux tuning (recommended)</strong> â€“ increase <code>vm.swappiness = 1</code>, set <code>kernel.shmmax</code> â‰¥ shared_buffers, etc.</li>
            </ul>
            <h4 id="configuring-node-1-master-">Configuring Node-1 (Master)</h4>
            <p>Before setting up physical replication, you need to prepare the primary server (Node-1) by adjusting its configuration to enable write-ahead logging (WAL) streaming and accept connections from standby servers. This section walks you through the required changes to PostgreSQL's configuration files and the creation of a replication role.</p>
            <p>I. Config file</p>
            <p>As the master, Node-1 must generate and retain sufficient WAL segments for standby servers to consume. Update <code>postgresql.conf</code> with appropriate settings.</p>
            <div>
                <pre><code class="language-conf"># Enable WAL suitable for physical replication
wal_level               = replica          # 'logical' if you also need logical slots
# Allow enough WAL sender processes for your standby servers
max_wal_senders         = 10               # &gt;= number of stand-bys + maintenance head-room
# Maintain replication slots to prevent WAL removal too early
max_replication_slots   = 10               # same logic as above
# Keep enough WAL files to let standbys catch up without recycling
wal_keep_size           = 512MB            # prevents WAL recycling before stand-bys catch up
# Listen only on the masterâ€™s address (or '*' to trust all)
listen_addresses        = '10.0.0.10'      # or '*' if all IPs are trusted
# Choose commit behavior: local yields speed; remote_apply ensures sync
synchronous_commit      = local            # change to 'remote_apply' for synchronous sets</code></pre>
            </div>
            <blockquote>
                <p><strong>Tip</strong> â€“ From v15 onward you can use <code>min_wal_size</code>/<code>max_wal_size</code> instead of a fixed <code>wal_keep_size</code> to auto-scale WAL retention.</p>
            </blockquote>
            <p>II. <code>pg_hba.conf</code></p>
            <p>Standby servers must be allowed to connect for replication. Add entries to <code>pg_hba.conf</code> specifying the replication database, user, and host addresses.</p>
            <div>
                <pre><code class="language-conf"># TYPE  DATABASE        USER        ADDRESS            METHOD
host    replication     replicator  10.0.0.11/32       md5
host    replication     replicator  10.0.0.12/32       md5</code></pre>
            </div>
            <p>III. Create the replication role</p>
            <p>A dedicated role with replication privileges is required for streaming WAL to standbys. Execute the following SQL on the master:</p>
            <div>
                <pre><code class="language-sql">CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD 'S3cUr3P@ss!';</code></pre>
            </div>
            <p>IV. Reload / restart Node-1</p>
            <p>After updating configuration files and creating the role, reload or restart PostgreSQL to apply changes.</p>
            <div>
                <pre><code class="language-bash">sudo systemctl restart postgresql</code></pre>
            </div>
            <h4 id="configuring-node-2-and-node-3-replicas-">Configuring Node-2 and Node-3 (Replicas)</h4>
            <p>Once the master is prepared, each standby (Node-2 and Node-3) needs to be bootstrapped from a base backup and configured to stream WAL. You will perform the same steps on both replicas, adjusting only the connection details as needed.</p>
            <p>I. Stop PostgreSQL</p>
            <p>Ensure PostgreSQL is not running on the replica before taking the base backup or restoring data.</p>
            <div>
                <pre><code class="language-bash">sudo systemctl stop postgresql</code></pre>
            </div>
            <p>II. Take a base-backup from the master</p>
            <p>Use <code>pg_basebackup</code> to clone the primaryâ€™s data directory, stream WAL, and automatically write recovery settings.</p>
            <div>
                <pre><code class="language-bash">sudo -u postgres pg_basebackup \
  -h 10.0.0.10 \
  -D /var/lib/pgsql/15/data \
  -U replicator \
  -W -P --wal-method=stream --write-recovery-conf</code></pre>
            </div>
            <p><em>The <code>--write-recovery-conf</code> switch auto-creates <code>standby.signal</code> and fills in <code>primary_conninfo</code>.</em></p>
            <p>III. (If you skipped <code>--write-recovery-conf</code>) edit <code>postgresql.conf</code></p>
            <p>Manually enable hot standby mode and configure connection to the master, specifying the replication slot unique to each standby.</p>
            <div>
                <pre><code class="language-conf">hot_standby          = on
primary_conninfo     = 'host=10.0.0.10 port=5432 user=replicator password=S3cUr3P@ss!'
primary_slot_name    = 'node2_slot'     # unique per standby (see slots below)</code></pre>
            </div>
            <p>If needed, create the standby signal file to trigger recovery mode (PostgreSQL v12+):</p>
            <div>
                <pre><code class="language-bash">touch /var/lib/pgsql/15/data/standby.signal</code></pre>
            </div>
            <p>IV. Start the replica</p>
            <p>With configuration in place, start PostgreSQL on the standby to begin streaming WAL from the master.</p>
            <div>
                <pre><code class="language-bash">sudo systemctl start postgresql</code></pre>
            </div>
            <h4 id="verifying-replication">Verifying Replication</h4>
            <p>After configuring both master and standbys, you should verify that WAL streaming is active and data changes propagate as expected. This section covers querying replication status and performing a simple functional test.</p>
            <p>I. On <strong>Node-1</strong></p>
            <p>Check the replication status view on the master to confirm standbys are connected and streaming.</p>
            <div>
                <pre><code class="language-sql">SELECT client_addr, state, sync_state
FROM   pg_stat_replication;</code></pre>
            </div>
            <p>You should see rows for <strong>10.0.0.11</strong> and <strong>10.0.0.12</strong> with <code>state = streaming</code>. If you configured synchronous replication (<code>synchronous_standby_names</code>, <code>synchronous_commit = remote_apply</code>) the <code>sync_state</code> column will be <code>sync</code> for the chosen stand-bys.</p>
            <p>II. Functional test</p>
            <p>Perform a simple create-and-read test to confirm that changes on the master appear on the replica almost immediately.</p>
            <div>
                <pre><code class="language-sql">-- Master (10.0.0.10)
CREATE TABLE replication_test (id SERIAL PRIMARY KEY, data TEXT);
INSERT INTO replication_test (data) VALUES ('Hello replicas');

-- Replica (10.0.0.11 or .12)
SELECT * FROM replication_test;  -- should return 1 row almost instantly</code></pre>
            </div>
            <h4 id="performing-a-fail-over">Performing a Fail-over</h4>
            <p>In a production environment, you need a plan for promoting a standby to master when the primary fails. This section outlines a manual fail-over process, though automation tools can streamline detection and promotion.</p>
            <p>I. <strong>Detect failure</strong> of Node-1 (often automated with Patroni, pg_auto_failover, etc.).</p>
            <p>II. <strong>Promote</strong> Node-2 (example)</p>
            <div>
                <pre><code class="language-bash">sudo -u postgres pg_ctl promote -D /var/lib/pgsql/15/data</code></pre>
            </div>
            <p>or</p>
            <div>
                <pre><code class="language-bash">touch /var/lib/pgsql/15/data/promote.signal</code></pre>
            </div>
            <p>III. <strong>Redirect applications</strong> to the new master (10.0.0.11).</p>
            <p>IV. <strong>Re-configure the old master</strong> (once repaired) as a replica: wipe its data dir, repeat the â€œReplicaâ€ steps, giving it a new slot (<code>node1_as_replica_slot</code>).</p>
            <h4 id="optional-replication-slots-highly-recommended-">Optional: Replication Slots (Highly Recommended)</h4>
            <p>Replication slots ensure that WAL segments needed by a standby are retained on the master until they have been safely replayed. This prevents standbys from falling too far behind and losing data.</p>
            <p>On <strong>Node-1</strong>:</p>
            <div>
                <pre><code class="language-sql">SELECT pg_create_physical_replication_slot('node2_slot');
SELECT pg_create_physical_replication_slot('node3_slot');</code></pre>
            </div>
            <p>Then, on each replicaâ€™s <code>postgresql.conf</code>, match the slot:</p>
            <div>
                <pre><code class="language-conf">primary_slot_name = 'node2_slot'   # or node3_slot accordingly</code></pre>
            </div>
            <p>Slots guarantee that WAL remains available until every replica has replayed itâ€”preventing the dreaded â€œrequested WAL segment has already been removedâ€.</p>
            <h4 id="extra-hardening-performance-tweaks">Extra Hardening &amp; Performance Tweaks</h4>
            <p>Beyond basic replication, additional configuration can improve resilience, disaster recovery capabilities, and performance. Consider these settings as part of a hardened, high-availability setup:</p>
            <p>
            <table>
                <tr>
                    <td>Setting</td>
                    <td>Why it matters (refer to ASCII diagram for scope)</td>
                </tr>
                <tr>
                    <td><code>checkpoint_timeout = 15min</code></td>
                    <td>Longer intervals reduce I/O on Node-1; ensure replicas can catch up.</td>
                </tr>
                <tr>
                    <td><code>archive_mode = on</code> + <code>archive_command</code></td>
                    <td>Off-site WAL shipping for disaster recovery beyond Node-2 &amp; Node-3.</td>
                </tr>
                <tr>
                    <td><code>hot_standby_feedback = on</code></td>
                    <td>Stops long-running queries on replicas from causing bloat on master.</td>
                </tr>
                <tr>
                    <td><code>backup_label</code> &amp; <code>recovery_target</code></td>
                    <td>For point-in-time restores (PITR) if required.</td>
                </tr>
            </table>
            </p>
        </article-section>
    </div>
    <footer>
        <div class="footer-columns">
            <div class="footer-column footer-about">
                <h2>About</h2>
                <p class="footer-message">Thanks for stopping by. This site is free to use; please be respectful and avoid misuse. For questions or collaboration, reach me on <a href="https://www.linkedin.com/in/adam-djellouli-1bb54619a/" title="LinkedIn Profile">LinkedIn</a> or <a href="https://github.com/djeada" title="GitHub Profile">GitHub</a>.</p>
                <p class="footer-signature">Built with care in Berlin (UTC+1).</p>
            </div>
            <div class="footer-column footer-links">
                <h2>Quick Links</h2>
                <ul class="footer-links-list">
                    <li><a href="https://adamdjellouli.com/index.html" title="Home">Home</a></li>
                    <li><a href="https://adamdjellouli.com/core/projects.html" title="Projects">Projects</a></li>
                    <li><a href="https://adamdjellouli.com/core/tools.html" title="Tools">Tools</a></li>
                    <li><a href="https://adamdjellouli.com/core/courses.html" title="Courses">Courses</a></li>
                    <li><a href="https://adamdjellouli.com/core/resume.html" title="Resume">Resume</a></li>
                    <li><a href="https://adamdjellouli.com/core/privacy_policy.html" title="Privacy Policy">Privacy Policy</a></li>
                    <li><a href="https://adamdjellouli.com/sitemap.xml" title="Sitemap">Sitemap</a></li>
                </ul>
            </div>
            <div class="footer-column footer-social">
                <h2>Follow</h2>
                <ul class="social-media">
                    <li>
                        <a aria-label="YouTube" class="fa fa-youtube" href="https://www.youtube.com/channel/UCGPoHTVjMN77wcGknXPHl1Q" rel="noopener" target="_blank" title="YouTube"></a>
                        <span class="social-label">YouTube</span>
                    </li>
                    <li>
                        <a aria-label="LinkedIn" class="fa fa-linkedin" href="https://www.linkedin.com/in/adam-djellouli-1bb54619a/" rel="noopener" target="_blank" title="LinkedIn"></a>
                        <span class="social-label">LinkedIn</span>
                    </li>
                    <li>
                        <a aria-label="Instagram" class="fa fa-instagram" href="https://www.instagram.com/linuxchallenges/" rel="noopener" target="_blank" title="Instagram"></a>
                        <span class="social-label">Instagram</span>
                    </li>
                    <li>
                        <a aria-label="GitHub" class="fa fa-github" href="https://github.com/djeada" title="GitHub"></a>
                        <span class="social-label">GitHub</span>
                    </li>
                </ul>
                <img alt="" aria-hidden="true" class="footer-mark" src="https://raw.githubusercontent.com/djeada/Personal-Website/master/images/symbol.png" />
            </div>
        </div>
        <div class="footer-bottom">
            <p id="copyright">
                Â© Adam Djellouli. All rights reserved.
            </p>
        </div>
        <script>
            document.getElementById("copyright").innerHTML = "&copy; " + new Date().getFullYear() + " Adam Djellouli. All rights reserved.";
        </script>
        <script src="/app.js"></script>
    </footer>
    <div id="pdf-spinner-overlay">
        <div class="spinner"></div>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-cpp.min.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
jax: ["input/TeX", "output/HTML-CSS"],
extensions: ["tex2jax.js"],
"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] },
tex2jax: { inlineMath: [ ["$", "$"] ], displayMath: [ ["$$","$$"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno" },
TeX: { noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } } },
messageStyle: "none"
});
</script>
<script async="" id="MathJax-script" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>

</html>